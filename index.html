<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Dashboard</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/countup.js@2.8.0/dist/countUp.umd.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        .card {
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.25);
        }
        
        [data-bs-theme="light"] .card {
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .metric-value {
            font-size: 2.75rem;
            font-weight: 900;
        }

        .metric-unit {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .form-control, .form-select {
            padding: 0.8rem 1rem;
        }
        
        .btn {
            padding: 0.75rem 1rem;
            font-weight: 600;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(25px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animated-card {
            animation: slideInUp 0.6s backwards;
        }

        .list-group-item.fade-out {
            transition: opacity 0.4s ease, transform 0.4s ease;
            opacity: 0;
            transform: translateX(-30px);
        }
    </style>
</head>
<body class="bg-body-tertiary">

    <div id="setup-screen">
        <div class="container">
            <div class="row min-vh-100 justify-content-center align-items-center">
                <div class="col-lg-6">
                    <div class="card shadow-lg border-0 rounded-4 p-4 animated-card">
                        <div class="card-body text-center">
                            <h1 class="card-title display-5 fw-bold mb-3">Data Dashboard Setup</h1>
                            <p class="card-text text-body-secondary mb-4">Enter your total monthly data bundle to begin.</p>
                            <form id="plan-form">
                                <div class="mb-3">
                                    <label for="total-data-input" class="form-label visually-hidden">Total Monthly Data (in GB)</label>
                                    <input type="number" id="total-data-input" class="form-control form-control-lg text-center" min="1" step="0.1" required placeholder="e.g., 100">
                                </div>
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary btn-lg">Start 30-Day Cycle</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="dashboard-screen" class="d-none">
        <div class="container-xxl py-4">
            <header class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-4 pb-3 border-bottom border-secondary-subtle">
                <h1 class="h2 fw-bold mb-0">Monthly Data Dashboard</h1>
                <div class="d-flex align-items-center gap-2">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="unit-toggle-switch">
                        <label class="form-check-label" for="unit-toggle-switch">Use MB</label>
                    </div>
                    <button id="theme-toggle-btn" class="btn btn-outline-secondary">
                        <i class="bi"></i>
                    </button>
                    <button id="reset-button" class="btn btn-danger">
                        <i class="bi bi-arrow-counterclockwise me-1"></i> Reset Plan
                    </button>
                </div>
            </header>

            <div id="data-cap-alert" class="alert alert-danger d-flex align-items-center d-none" role="alert">
                <i class="bi bi-exclamation-triangle-fill flex-shrink-0 me-3 h4 mb-0"></i>
                <div>
                    <strong>Data Cap Alert!</strong> You have dropped below your threshold of <span id="alert-threshold-value"></span>.
                </div>
            </div>

            <div class="row g-4 mb-4">
                <div class="col-lg-3 col-md-6">
                    <div class="card h-100 shadow-sm border-0 rounded-4 animated-card" style="animation-delay: 100ms;">
                        <div class="card-body">
                            <h5 class="card-title text-body-secondary fw-semibold">Days Remaining</h5>
                            <p id="days-left" class="metric-value mb-0">--</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="card h-100 shadow-sm border-0 rounded-4 animated-card" style="animation-delay: 200ms;">
                        <div class="card-body">
                            <h5 class="card-title text-body-secondary fw-semibold">Data Remaining</h5>
                            <p class="metric-value text-primary mb-0"><span id="data-left">--</span> <small id="data-left-unit" class="text-body-secondary fw-semibold metric-unit"></small></p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="card h-100 shadow-sm border-0 rounded-4 animated-card" style="animation-delay: 300ms;">
                        <div class="card-body">
                             <h5 class="card-title text-body-secondary fw-semibold">New Daily Allowance <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Remaining data divided by remaining days"></i></h5>
                            <p class="metric-value mb-0"><span id="daily-allowance">--</span> <small id="daily-allowance-unit" class="text-body-secondary fw-semibold metric-unit"></small></p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="card h-100 shadow-sm border-0 rounded-4 bg-primary-subtle border-primary animated-card" style="animation-delay: 400ms;">
                        <div class="card-body">
                            <h5 class="card-title text-body-secondary fw-semibold">Data Depletion Forecast <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Projected date your data will run out based on average usage."></i></h5>
                            <p id="forecast-value" class="metric-value mb-0" style="font-size: 1.9rem;">--</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-4">
                <div class="col-lg-4">
                    <div class="vstack gap-4">
                        <div class="card shadow-sm border-0 rounded-4 animated-card" style="animation-delay: 500ms;">
                            <div class="card-body p-4">
                                <h4 class="card-title fw-bold mb-3">Update & Settings</h4>
                                <form id="usage-form">
                                    <div class="mb-3">
                                        <label for="remaining-data-input" class="form-label">Current Remaining Data (<span class="unit-label">GB</span>)</label>
                                        <div class="input-group">
                                            <input type="number" id="remaining-data-input" class="form-control" min="0" step="0.01" required>
                                            <span class="input-group-text unit-label">GB</span>
                                        </div>
                                    </div>
                                    <div class="d-grid">
                                        <button type="submit" class="btn btn-primary">Update & Recalculate</button>
                                    </div>
                                </form>
                                <hr class="my-4">
                                <div class="mb-3">
                                    <label for="start-date-input" class="form-label">Cycle Start Date</label>
                                    <input type="date" id="start-date-input" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label for="alert-threshold-input" class="form-label">Data Cap Alert Threshold (<span class="unit-label">GB</span>)</label>
                                    <select class="form-select" id="alert-threshold-input">
                                        <option value="5">5 GB</option>
                                        <option value="10">10 GB</option>
                                        <option value="15">15 GB</option>
                                        <option value="20">20 GB</option>
                                        <option value="25">25 GB</option>
                                    </select>
                                </div>
                                <button id="export-csv-btn" class="btn btn-outline-secondary w-100"><i class="bi bi-download me-2"></i>Export History to CSV</button>
                            </div>
                        </div>
                        <div class="card shadow-sm border-0 rounded-4 animated-card" style="animation-delay: 600ms;">
                            <div class="card-body p-4">
                                <h4 class="card-title fw-bold mb-3">Update History</h4>
                                <div id="history-log-container" class="overflow-auto" style="max-height: 450px;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-8">
                    <div class="vstack gap-4">
                        <div class="card shadow-sm border-0 rounded-4 animated-card" style="animation-delay: 700ms;">
                            <div class="card-body p-4">
                                <h4 class="card-title fw-bold mb-3">Remaining Data Trend</h4>
                                <div class="chart-container">
                                    <canvas id="usageTrendChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="row g-4">
                            <div class="col-md-6">
                                <div class="card shadow-sm border-0 rounded-4 h-100 animated-card" style="animation-delay: 800ms;">
                                    <div class="card-body p-4">
                                        <h4 class="card-title fw-bold mb-3">Current Burn Rate</h4>
                                        <div class="chart-container" style="height: 250px;">
                                            <canvas id="burnRateChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card shadow-sm border-0 rounded-4 h-100 animated-card" style="animation-delay: 900ms;">
                                    <div class="card-body p-4">
                                        <h4 class="card-title fw-bold mb-3">Consumption Milestones</h4>
                                        <div id="milestones-container" class="d-flex flex-column justify-content-center h-100 gap-3">
                                            </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            let state = {};
            const defaultState = {
                initialTotalData: null,
                startDate: null,
                history: [],
                alertThreshold: 10,
                theme: 'dark',
                unit: 'GB'
            };
            
            const setupScreen = document.getElementById('setup-screen');
            const dashboardScreen = document.getElementById('dashboard-screen');
            const planForm = document.getElementById('plan-form');
            const totalDataInput = document.getElementById('total-data-input');
            const usageForm = document.getElementById('usage-form');
            const remainingDataInput = document.getElementById('remaining-data-input');
            const resetButton = document.getElementById('reset-button');
            const themeToggleButton = document.getElementById('theme-toggle-btn');
            const alertThresholdInput = document.getElementById('alert-threshold-input');
            const exportCsvBtn = document.getElementById('export-csv-btn');
            const unitToggleSwitch = document.getElementById('unit-toggle-switch');
            const unitLabels = document.querySelectorAll('.unit-label');
            const startDateInput = document.getElementById('start-date-input');
            const daysLeftEl = document.getElementById('days-left');
            const dataLeftEl = document.getElementById('data-left');
            const dataLeftUnitEl = document.getElementById('data-left-unit');
            const dailyAllowanceEl = document.getElementById('daily-allowance');
            const dailyAllowanceUnitEl = document.getElementById('daily-allowance-unit');
            const forecastValueEl = document.getElementById('forecast-value');
            const historyLogContainer = document.getElementById('history-log-container');
            const dataCapAlert = document.getElementById('data-cap-alert');
            const alertThresholdValue = document.getElementById('alert-threshold-value');
            const milestonesContainer = document.getElementById('milestones-container');
            const usageTrendCtx = document.getElementById('usageTrendChart').getContext('2d');
            const burnRateCtx = document.getElementById('burnRateChart').getContext('2d');

            let usageTrendChart, burnRateChart;
            let daysLeftAnim, dataLeftAnim, dailyAllowanceAnim;
            const CYCLE_DAYS = 30;
            const GB_TO_MB = 1024;

            function loadState() {
                try {
                    const storedState = localStorage.getItem('dataDashboardState_v6');
                    state = storedState ? JSON.parse(storedState) : { ...defaultState };
                } catch (e) {
                    console.error("Failed to load state from localStorage", e);
                    state = { ...defaultState };
                }
            }

            function saveState() {
                try {
                    localStorage.setItem('dataDashboardState_v6', JSON.stringify(state));
                } catch (e) {
                    console.error("Failed to save state to localStorage", e);
                }
            }

            function initializeApp() {
                loadState();
                applyTheme(state.theme);
                if (state.startDate) {
                    showDashboard();
                    updateUI();
                }
                const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                tooltipTriggerList.map(function (tooltipTriggerEl) {
                  return new bootstrap.Tooltip(tooltipTriggerEl)
                });
            }
            
            function showDashboard() {
                setupScreen.classList.add('d-none');
                dashboardScreen.classList.remove('d-none');
            }

            function startPlan(e) {
                e.preventDefault();
                const totalData = parseFloat(totalDataInput.value);
                if (isNaN(totalData) || totalData <= 0) {
                    alert("Please enter a valid total data amount.");
                    return;
                }
                
                state.initialTotalData = totalData;
                state.startDate = Date.now();
                state.history = [{ date: state.startDate, remaining: totalData }];
                saveState();
                showDashboard();
                updateUI();
                totalDataInput.value = '';
            }

            function updateRemainingData(e) {
                e.preventDefault();
                let remainingData = parseFloat(remainingDataInput.value);
                if (isNaN(remainingData) || remainingData < 0) {
                    alert('Please enter a valid remaining data amount.');
                    return;
                }
                if (state.unit === 'MB') {
                    remainingData /= GB_TO_MB;
                }
                if (remainingData > state.initialTotalData) {
                    alert('Remaining data cannot be more than the initial total.');
                    return;
                }
                state.history.push({ date: Date.now(), remaining: remainingData });
                state.history.sort((a, b) => a.date - b.date);
                saveState();
                updateUI();
                remainingDataInput.value = '';
            }

            function deleteHistoryEntry(timestamp, element) {
                element.classList.add('fade-out');
                setTimeout(() => {
                    state.history = state.history.filter(entry => entry.date !== timestamp);
                    if (state.history.length < 1) {
                         resetPlan();
                         return;
                    }
                    saveState();
                    updateUI();
                }, 400);
            }
            
            function resetPlan() {
                if (confirm('Are you sure? All data will be lost.')) {
                    localStorage.removeItem('dataDashboardState_v6');
                    window.location.reload();
                }
            }
            
            function convertToUnit(valueInGB) {
                return state.unit === 'MB' ? valueInGB * GB_TO_MB : valueInGB;
            }

            function updateUI() {
                if (!state.startDate) return;

                const isMB = state.unit === 'MB';
                unitToggleSwitch.checked = isMB;
                unitLabels.forEach(label => label.textContent = state.unit);
                
                const now = new Date();
                const startDate = new Date(state.startDate);
                
                const elapsedMilliseconds = now - startDate;
                const elapsedDays = Math.max(0, elapsedMilliseconds / (1000 * 60 * 60 * 24));
                const daysRemaining = Math.max(0, Math.ceil(CYCLE_DAYS - elapsedDays));
                
                const currentData = state.history[state.history.length - 1];
                const dataRemainingGB = currentData.remaining;
                const dataUsedGB = state.initialTotalData - dataRemainingGB;
                const newDailyAllowanceGB = daysRemaining > 0 ? dataRemainingGB / daysRemaining : 0;
                
                let avgDailyUsageGB = 0;
                if (state.history.length > 1) {
                    const firstEntry = state.history[0];
                    const lastEntry = state.history[state.history.length - 1];
                    const dataUsedBetweenEntries = firstEntry.remaining - lastEntry.remaining;
                    const daysBetweenEntries = (lastEntry.date - firstEntry.date) / (1000 * 60 * 60 * 24);
                    if (daysBetweenEntries > 0.01) { 
                        avgDailyUsageGB = dataUsedBetweenEntries / daysBetweenEntries;
                    }
                }

                let forecastDisplay = "--";
                if (avgDailyUsageGB > 0 && dataRemainingGB > 0) {
                    const daysUntilEmpty = dataRemainingGB / avgDailyUsageGB;
                    if (daysUntilEmpty > 1000) {
                        forecastDisplay = "Never";
                    } else {
                        const depletionDate = new Date(now.getTime() + daysUntilEmpty * 24 * 60 * 60 * 1000);
                        forecastDisplay = depletionDate.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
                    }
                } else if (dataUsedGB <= 0) {
                    forecastDisplay = "N/A";
                }

                // Fallback for metrics if CountUp is not available
                if (typeof CountUp === 'undefined') {
                    daysLeftEl.textContent = Math.round(daysRemaining);
                    dataLeftEl.textContent = convertToUnit(dataRemainingGB).toFixed(isMB ? 0 : 2);
                    dailyAllowanceEl.textContent = convertToUnit(newDailyAllowanceGB).toFixed(isMB ? 0 : 2);
                } else {
                    const animOptions = { duration: 1.2, useEasing: true, decimalPlaces: isMB ? 0 : 2 };
                    if (!daysLeftAnim) {
                        daysLeftAnim = new CountUp(daysLeftEl, Math.round(daysRemaining), { ...animOptions, decimalPlaces: 0 });
                        dataLeftAnim = new CountUp(dataLeftEl, convertToUnit(dataRemainingGB), animOptions);
                        dailyAllowanceAnim = new CountUp(dailyAllowanceEl, convertToUnit(newDailyAllowanceGB), animOptions);
                        [daysLeftAnim, dataLeftAnim, dailyAllowanceAnim].forEach(a => a.start());
                    } else {
                        daysLeftAnim.update(Math.round(daysRemaining));
                        dataLeftAnim.options.decimalPlaces = animOptions.decimalPlaces;
                        dataLeftAnim.update(convertToUnit(dataRemainingGB));
                        dailyAllowanceAnim.options.decimalPlaces = animOptions.decimalPlaces;
                        dailyAllowanceAnim.update(convertToUnit(newDailyAllowanceGB));
                    }
                }
                
                dataLeftUnitEl.textContent = state.unit;
                dailyAllowanceUnitEl.textContent = state.unit;
                forecastValueEl.textContent = forecastDisplay;
                
                startDateInput.value = new Date(state.startDate).toISOString().split('T')[0];
                alertThresholdInput.value = state.alertThreshold;
                renderHistory();
                updateAlerts(dataRemainingGB);
                updateMilestones(dataUsedGB);
                renderCharts(dataUsedGB, dataRemainingGB);
            }

            function updateAlerts(dataRemainingGB) {
                const thresholdInCurrentUnit = convertToUnit(state.alertThreshold);
                alertThresholdValue.textContent = `${thresholdInCurrentUnit.toFixed(0)} ${state.unit}`;
                if (dataRemainingGB < state.alertThreshold) {
                    dataCapAlert.classList.remove('d-none');
                } else {
                    dataCapAlert.classList.add('d-none');
                }
            }

            function updateMilestones(dataUsedGB) {
                const percentageUsed = (dataUsedGB / state.initialTotalData) * 100;
                const milestones = [
                    { percent: 25, icon: 'bi-reception-2', label: '25% Consumed' },
                    { percent: 50, icon: 'bi-reception-3', label: '50% Consumed' },
                    { percent: 75, icon: 'bi-reception-4', label: '75% Consumed' },
                ];
                milestonesContainer.innerHTML = milestones.map(m => {
                    const isAchieved = percentageUsed >= m.percent;
                    return `<div class="d-flex align-items-center p-2 rounded ${isAchieved ? 'bg-success-subtle text-success-emphasis' : 'bg-body-secondary'}">
                            <i class="bi ${m.icon} h3 me-3 mb-0"></i>
                            <span class="fw-semibold">${m.label}</span>
                        </div>`;
                }).join('');
            }
            
            function renderHistory() {
                historyLogContainer.innerHTML = '';
                const historyToShow = state.history.slice(1);
                if (historyToShow.length === 0) {
                    historyLogContainer.innerHTML = '<p class="text-body-secondary">No updates logged yet.</p>'; return;
                }
                const listGroup = document.createElement('div');
                listGroup.className = 'list-group list-group-flush';
                
                [...historyToShow].reverse().forEach(entry => {
                    const date = new Date(entry.date);
                    const item = document.createElement('div');
                    item.className = 'list-group-item d-flex justify-content-between align-items-center bg-transparent px-0';
                    const remainingValue = convertToUnit(entry.remaining);
                    const displayValue = `${remainingValue.toFixed(state.unit === 'MB' ? 0 : 2)} ${state.unit}`;
                    item.innerHTML = `<div class="me-auto">
                            <div class="fw-bold">Updated to ${displayValue}</div>
                            <small class="text-body-secondary">${date.toLocaleString()}</small>
                        </div>
                        <button class="btn btn-sm btn-outline-danger border-0">
                            <i class="bi bi-trash-fill"></i>
                        </button>`;
                    item.querySelector('button').addEventListener('click', () => deleteHistoryEntry(entry.date, item));
                    listGroup.appendChild(item);
                });
                historyLogContainer.appendChild(listGroup);
            }
            
            function getChartColors() {
                const isDarkMode = document.documentElement.dataset.bsTheme === 'dark';
                return {
                    gridColor: isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)',
                    textColor: isDarkMode ? '#dee2e6' : '#212529',
                    primaryColor: '#0d6efd',
                    secondaryColor: '#6c757d',
                    bodyColor: isDarkMode ? '#2b3035' : '#ffffff'
                };
            }
            
            function renderCharts(dataUsedGB, dataRemainingGB) {
                if (typeof Chart === 'undefined') {
                    console.error("Chart.js is not loaded. Skipping chart rendering.");
                    return;
                }

                const colors = getChartColors();
                
                if (usageTrendChart) usageTrendChart.destroy();
                usageTrendChart = new Chart(usageTrendCtx, {
                    type: 'line',
                    data: {
                        labels: state.history.map(h => new Date(h.date).toLocaleDateString()),
                        datasets: [{
                            label: `Remaining Data (${state.unit})`,
                            data: state.history.map(h => convertToUnit(h.remaining)),
                            borderColor: colors.primaryColor,
                            backgroundColor: 'rgba(13, 110, 253, 0.15)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, animation: { duration: 1000 }, scales: { y: { beginAtZero: false, grid: { color: colors.gridColor }, ticks: { color: colors.textColor } }, x: { grid: { display: false }, ticks: { color: colors.textColor } } }, plugins: { legend: { display: false } } }
                });

                if (burnRateChart) burnRateChart.destroy();
                burnRateChart = new Chart(burnRateCtx, {
                    type: 'doughnut',
                    data: {
                        labels: [`Used (${state.unit})`, `Remaining (${state.unit})`],
                        datasets: [{ data: [convertToUnit(dataUsedGB), convertToUnit(dataRemainingGB)], backgroundColor: [colors.secondaryColor, colors.primaryColor], borderColor: colors.bodyColor, borderWidth: 5 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, cutout: '70%', animation: { animateRotate: true, animateScale: true, duration: 1200 }, plugins: { legend: { position: 'bottom', labels: { color: colors.textColor } } } }
                });
            }

            function applyTheme(theme) {
                document.documentElement.dataset.bsTheme = theme;
                const icon = themeToggleButton.querySelector('i');
                icon.className = theme === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-stars-fill';
                state.theme = theme;
                saveState();
            }

            function handleThemeToggle() {
                applyTheme(state.theme === 'dark' ? 'light' : 'dark');
                if (state.startDate) updateUI();
            }

            function exportToCSV() {
                if (state.history.length <= 1) { alert('No history to export.'); return; }
                let csvContent = "data:text/csv;charset=utf-8,Date,Time,Remaining GB\n";
                state.history.slice(1).forEach(entry => {
                    const d = new Date(entry.date);
                    csvContent += `${d.toLocaleDateString()},${d.toLocaleTimeString()},${entry.remaining.toFixed(2)}\n`;
                });
                const link = document.createElement("a");
                link.setAttribute("href", encodeURI(csvContent));
                link.setAttribute("download", "data_usage_history.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            planForm.addEventListener('submit', startPlan);
            usageForm.addEventListener('submit', updateRemainingData);
            resetButton.addEventListener('click', resetPlan);
            themeToggleButton.addEventListener('click', handleThemeToggle);
            alertThresholdInput.addEventListener('change', (e) => {
                state.alertThreshold = parseFloat(e.target.value);
                saveState();
                updateAlerts(state.history.at(-1).remaining);
            });
            unitToggleSwitch.addEventListener('change', (e) => {
                state.unit = e.target.checked ? 'MB' : 'GB';
                saveState();
                updateUI();
            });
            startDateInput.addEventListener('change', (e) => {
                const newDate = new Date(e.target.value);
                if (newDate > new Date()) {
                    alert("Start date cannot be in the future.");
                    startDateInput.value = new Date(state.startDate).toISOString().split('T')[0];
                    return;
                }
                const newTimestamp = newDate.getTime();
                state.startDate = newTimestamp;
                if (state.history.length > 0) state.history[0].date = newTimestamp;
                state.history.sort((a, b) => a.date - b.date);
                saveState();
                updateUI();
            });
            exportCsvBtn.addEventListener('click', exportToCSV);
            
            initializeApp();
        });
    </script>
</body>
</html>